# WaveFunctionCollapse
 Simple wave function collapse map generator 3D Unity project.

## TL;DR
A simple 3D Unity project, with prefabs made from cube primitives as placeholders for more complex rooms. The main algorithm is a barebones wave function collapse, with   no handling of impossible combinations or dead ends. This should be implemented with some exception handling and/or 'rollback' mechanism to revert back to a previous state.

## Overview
The main action happens in MapController.cs. Here a grid of Tile instances is initialised that represent the map, references to these instances are also kept in a normal List to allow sorting. On each pass, the possible prefabs are calculated for each grid position. The grid position with the fewest possible prefabs is the next to 'collapse'. If multiple prefabs can occupy this position then one is picked at random. On the next iteration, the grid is recalculated, the List is sorted by how many possible prefabs can occupy a grid position is sorted again, and the process repeats until all grid positions are collapsed.

The term 'signature' in the code represents its encoding about what connections to neighbouring tiles it needs. The convention is [up, right, down, left] represented by a -1, 0, or 1 depending on if a connection is needed (1), connection not needed (0) or either is fine (-1). So for example if a grid position has the signature {-1,-1,0,1} then it can only be filled with a prefab that doesn't have a connection on the 'down' edge and does have a connection on the 'left' edge.

## Scripts
### WaveFuncCollapse.cs

This script implements the wave function collapse algorithm. The key components of this script include:

**CreateMap()**: Executes the wave function collapse algorithm to generate the map by iteratively selecting tiles to fit the grid.

**UpdateTilePlacement()**: Updates a grid tile with the assigned prefab and rotation after collapsing.

**CalculatePossibilitySignature()**: Determines the signature of possible connections needed for a tile at a specific grid location.

**CalculatePossibilityIndexes()**: Calculates the indexes of valid tiles from TilesetWithRotations that satisfy the signature requirements.

**UpdateSignaturesAndIndexes()**: Updates the possibility signature and indexes for each grid tile.

### MapController.cs

This script is responsible for instantiating the generated map in Unity. It accesses the grid information generated by WaveFuncCollapse.cs and instantiates the corresponding prefabs with the appropriate rotation.

### Tile.cs

This class represents a single tile in the grid. It stores information about its position, whether it has been collapsed (assigned a prefab), its possible connections, and the true connections after collapsing.

### PrefabAdapter in Tile.cs

This class acts as an adapter to bridge the gap between Unity prefabs and the grid tiles. It stores information about the prefab's connections and rotation.

### Tileset.cs

Singleton that is the main place to work on creating a tileset out of prefabs.

**CalculateValidRotations()**: Calculates all valid rotations for each tile in the Tileset and stores them in the tilesetWithRotations list.

## Modyfiying the code for your needs
All prefabs are handled in the Tileset object. Stick with the convention of using +z as up and +x as right in your prefabs and their footprint should be a square. Update the prefab length variable in the Tileset object to be the same as the your prefabs. There is an 'exempt from generations' List in the Tileset gameobject. Use this if you have prefabs you want to manually place, like rooms, that are excluded from generation otherwise. 


